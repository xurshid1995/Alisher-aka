{% extends "base.html" %}

{% block extra_css %}
<style>
.store-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin: 20px 0;
}

.store-card {
    width: 100%;
    height: 350px;
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #e74c3c;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.store-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

    .store-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .store-name {
        font-size: 1.4rem;
        font-weight: bold;
        color: #2c3e50;
    }

    .store-status {
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .status-good { background: #d5e8d4; color: #2e7d32; }
    .status-medium { background: #fff3cd; color: #856404; }
    .status-low { background: #f8d7da; color: #721c24; }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #2ecc71);
        transition: width 0.3s ease;
    }

    .progress-fill.medium { background: linear-gradient(90deg, #f39c12, #e67e22); }
    .progress-fill.low { background: linear-gradient(90deg, #e74c3c, #c0392b); }

    .store-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin: 1rem 0;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .store-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        justify-content: space-between;
    }

    .btn-small {
        padding: 0.5rem 0.8rem;
        font-size: 0.85rem;
        border-radius: 4px;
        text-decoration: none;
        transition: all 0.3s ease;
        flex: 1;
        text-align: center;
        border: none;
        cursor: pointer;
    }

    .btn-view {
        background: #3498db;
        color: white;
    }

    .btn-view:hover {
        background: #2980b9;
        transform: translateY(-1px);
    }

    .btn-edit {
        background: #f39c12;
        color: white;
    }

    .btn-edit:hover {
        background: #e67e22;
        transform: translateY(-1px);
    }

    .btn-delete {
        background: #e74c3c;
        color: white;
    }

    .btn-delete:hover {
        background: #c0392b;
        transform: translateY(-1px);
    }

    /* RESPONSIVE DESIGN - BIR QATORDA 3 TA */
    @media (max-width: 1200px) {
        .store-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .store-grid {
            grid-template-columns: 1fr;
        }
    }

    /* MUTLAQ O'ZGARMAS QOIDALAR */
    * {
        box-sizing: border-box;
    }
</style>
{% endblock %}

{% block content %}
<!-- Content Header -->
<div class="content-header" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1>üè¨ Do'konlar boshqaruvi</h1>
        <div class="breadcrumb">Dokon boshqaruvi / Do'konlar</div>
    </div>
    <a href="/add_store" class="btn btn-success" style="padding: 0.6rem 1.5rem; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.3s; font-weight: 500;">
        ‚ûï Yangi do'kon qo'shish
    </a>
</div>

<!-- Stores Grid -->
<div class="store-grid">
    {% for store in stores %}
    <div class="store-card" data-store-id="{{ store.id }}">
        <div class="store-header">
            <div class="store-name">{{ store.name }}</div>
        </div>

        <div class="store-info">
            <div class="info-item">
                <span>üìç</span>
                <span>{{ store.address[:30] }}{% if store.address|length > 30 %}...{% endif %}</span>
            </div>
            <div class="info-item">
                <span>üë§</span>
                <span>{{ store.manager_name }}</span>
            </div>
            <div class="info-item">
                <span>üìû</span>
                <span>{{ store.phone or 'Telefon yo\'q' }}</span>
            </div>
            <div class="info-item">
                <span>üìÖ</span>
                <span>{{ store.created_date.strftime('%d.%m.%Y') if store.created_date else 'Noma\'lum' }}</span>
            </div>
        </div>

        <div class="store-actions">
            <a href="/store/{{ store.id }}" class="btn-small btn-view">
                üëÅÔ∏è Ko'rish
            </a>
            <a href="/edit_store/{{ store.id }}" class="btn-small btn-edit">
                ‚úèÔ∏è Tahrirlash
            </a>
            <button data-store-id="{{ store.id }}" 
                    data-store-name="{{ store.name }}"
                    onclick="deleteStore('{{ store.id }}', '{{ store.name }}')" 
                    class="btn-small btn-delete">
                üóëÔ∏è O'chirish
            </button>
        </div>
    </div>
    {% else %}
    <div class="store-card" style="grid-column: 1 / -1; text-align: center;">
        <h3>Do'konlar topilmadi</h3>
        <p style="color: #7f8c8d; margin: 1rem 0;">Hali do'konlar qo'shilmagan. Birinchi do'konni qo'shing!</p>
        <a href="/add_store" class="btn btn-success">
            ‚ûï Birinchi do'konni qo'shish
        </a>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Sidebar active link
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Do\'konlar sahifasi yuklandi');
    });

    // Do'kon o'chirish funksiyasi
    function deleteStore(storeId, storeName) {
        console.log('üóëÔ∏è O\'chirish funksiyasi chaqirildi!');
        console.log('   Store ID:', storeId, typeof storeId);
        console.log('   Store Name:', storeName, typeof storeName);
        
        // Validatsiya
        if (!storeId || storeId === 'undefined' || storeId === '') {
            console.error('‚ùå Store ID noto\'g\'ri:', storeId);
            alert('Xatolik: Dokon ID topilmadi!');
            return;
        }
        
        if (confirm(`Haqiqatan ham "${storeName}" do'konini o'chirmoqchimisiz?\n\nDiqqat: Bu amal qaytarib bo'lmaydi!`)) {
            console.log('‚úÖ Foydalanuvchi tasdiqladi, API ga so\'rov yuborilmoqda...');
            
            fetch(`/api/store/${storeId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                console.log('API javob olindi:', response.status, response.statusText);
                return response.json().then(data => {
                    console.log('üìã Server javob ma\'lumotlari:', data);
                    if (response.ok) {
                        console.log('‚úÖ Muvaffaqiyat! Sahifa qayta yuklanmoqda...');
                        alert(data.message || 'Do\'kon muvaffaqiyatli o\'chirildi!');
                        window.location.reload();
                    } else {
                        console.error('‚ùå API xatosi:', response.status, data);
                        alert('Xatolik: ' + (data.error || data.message || 'Do\'konni o\'chirib bo\'lmadi'));
                    }
                });
            })
            .catch(error => {
                console.error('Fetch xatosi:', error);
                alert('Aloqa xatosi! Qaytadan urinib ko\'ring.');
            });
        } else {
            console.log('Foydalanuvchi bekor qildi');
        }
    }

    function toggleStore(storeId, isActive) {
        // API ga so'rov yuborish
        fetch(`/api/store/${storeId}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                is_active: isActive
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Store toggle response:', data);
            if (data.success) {
                window.location.reload();
            } else {
                alert('Xatolik: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Toggle xatosi:', error);
            alert('Aloqa xatosi!');
        });
    }

</script>
{% endblock %}
